<!DOCTYPE html><html lang="ja">
<head>
<meta charset="utf-8" />
<title>Vivliostyle Host</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
html,body{margin:0;padding:0;height:100%;}
#vivliostyle-menu-bar{display:none!important}
#vivliostyle-viewer-viewport{top:0!important;background:#fff;}
</style>
</head>
<body>
<div id="vivliostyle-viewer"></div>
<div id="vivliostyle-viewer-viewport" data-vivliostyle-viewer-viewport></div>
<div id="vivliostyle-menu-bar"></div>
<div id="vivliostyle-message-dialog"></div>
<script>
(function(){
  const CDN = "https://unpkg.com/@vivliostyle/viewer@latest/lib/js/vivliostyle-viewer.js";
  let lastBlobUrl = null;

  function loadViewer() {
    return new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = CDN;
      s.onload = res;
      s.onerror = () => rej(new Error('Vivliostyle Viewer load error'));
      document.head.appendChild(s);
    });
  }

  function renderContent(html) {
    if (lastBlobUrl) {
      try { URL.revokeObjectURL(lastBlobUrl); } catch(e) {}
    }
    const blob = new Blob([html], { type: 'text/html' });
    lastBlobUrl = URL.createObjectURL(blob);
    location.hash = '#src=' + encodeURIComponent(lastBlobUrl);
  }

  window.addEventListener('message', (event) => {
    const { type, html } = event.data || {};
    if (type === 'update' && typeof html === 'string') {
      renderContent(html);
    }
  });

  loadViewer().then(() => {
    parent.postMessage({ type: 'ready' }, '*');
  }).catch(err => {
    console.error(err);
    parent.postMessage({ type: 'error', message: err.message }, '*');
  });
})();
</script>
</body>
</html>
