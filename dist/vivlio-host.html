<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Vivliostyle Preview Host</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { margin:0; padding:0; height:100%; }
    body { font-family: system-ui, sans-serif; line-height:1.5; }
    #viewer-root { width:100%; height:100%; position:relative; overflow:auto; }
    #status { position:absolute; top:4px; right:8px; background:rgba(0,0,0,.6); color:#fff; font-size:11px; padding:2px 6px; border-radius:4px; z-index:10; }
    .error { color:#c00; }
    pre.log { font-size:11px; background:#111; color:#eee; padding:6px; margin:8px; max-height:40%; overflow:auto; }
  </style>
  <!-- 固定バージョン (例) NOTE: integrity 値は本番で計測し直す -->
  <script src="https://unpkg.com/@vivliostyle/viewer@2.34.1/dist/vivliostyle-viewer.js"></script>
  <script src="https://unpkg.com/@vivliostyle/vfm@2.2.1/dist/vfm.min.js"></script>
</head>
<body>
  <div id="viewer-root">
    <div id="status">loading</div>
    <div id="log" style="display:none"></div>
  </div>
  <script>
    const statusEl = document.getElementById('status');
    const viewerRoot = document.getElementById('viewer-root');
    function setStatus(msg){ statusEl.textContent = msg; }
    function log(msg, obj){ console.debug('[VivlioDBG][iframe]', msg, obj||''); }

    let lastMarkdownHash = null;
    let viewerInstance = null;
    let ready = false;
    let queuedMarkdown = null; // 直近のみ保持（将来バッファ拡張可）

    function hash(str){
      let h = 0, i=0, len = str.length;
      while(i < len){ h = (h*31 + str.charCodeAt(i++))|0; }
      return (h>>>0).toString(16);
    }

    async function ensureInit(){
      if(ready) return true;
      if(!window.Vivliostyle || !window.vfm){ return false; }
      try {
        viewerInstance = window.Vivliostyle.viewer.create(viewerRoot);
        ready = true;
        setStatus('ready');
        log('viewer instance created');
        // 親へ ready 通知（初期化完了後）
        if (window.parent && window.parent !== window) {
          log('posting ready');
          window.parent.postMessage({ type: 'vivlio:ready' }, '*');
        }
        if(queuedMarkdown){
          const md = queuedMarkdown; queuedMarkdown = null;
          renderMarkdown(md); // flush
        }
      } catch(e){
        console.error('[VivlioDBG][iframe] viewer create failed', e);
        setStatus('init error');
      }
      return ready;
    }

    async function renderMarkdown(md){
      if(!await ensureInit()) { queuedMarkdown = md; return; }
      const currentHash = hash(md);
      if(currentHash === lastMarkdownHash){ log('skip same hash', currentHash); return; }
      lastMarkdownHash = currentHash;
      setStatus('parsing');
      try {
        const htmlBody = window.vfm.render(md || '');
        const docHtml = `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>preview</title></head><body>${htmlBody}</body></html>`;
        setStatus('loading');
        const blobUrl = URL.createObjectURL(new Blob([docHtml], { type: 'text/html' }));
        await viewerInstance.load(blobUrl);
        setStatus('ok');
      } catch(e){
        console.error('[VivlioDBG][iframe] render error', e);
        setStatus('error');
        viewerRoot.insertAdjacentHTML('beforeend', `<pre class="log">${String(e).replace(/</g,'&lt;')}</pre>`);
      }
    }

    window.addEventListener('message', (ev)=>{
      const { type, markdown } = ev.data || {};
      if(type === 'markdown:update-raw'){
        log('receive raw markdown', { length: (markdown||'').length });
        renderMarkdown(markdown||'');
      }
    });

    // 初期化リトライ（Vivliostyle / vfm スクリプトロード待機）
    const initInterval = setInterval(() => {
      if(ready) { clearInterval(initInterval); return; }
      ensureInit();
    }, 100);
    // 安全解除: 10秒で諦め
    setTimeout(()=>{ if(!ready){ clearInterval(initInterval); setStatus('timeout'); } }, 10000);
  </script>
</body>
</html>
