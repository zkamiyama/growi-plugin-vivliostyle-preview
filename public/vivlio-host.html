<!DOCTYPE html><html lang="ja">
<head>
<meta charset="utf-8" />
<title>Vivliostyle Host</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
html,body{margin:0;padding:0;height:100%;}
#fallback{position:absolute;inset:0;overflow:auto;font:14px system-ui;display:none;background:#fff;padding:12px;}
#log{position:fixed;left:0;right:0;bottom:0;max-height:35%;overflow:auto;font:11px monospace;background:#000c;color:#0f0;margin:0;display:none;white-space:pre-wrap;z-index:9999;padding:4px;}
#vivliostyle-menu-bar{display:none!important}
#vivliostyle-viewer-viewport{top:0!important;background:#fff;}
</style>
</head>
<body>
<div id="vivliostyle-viewer"></div>
<div id="vivliostyle-viewer-viewport" data-vivliostyle-viewer-viewport></div>
<div id="vivliostyle-menu-bar"></div>
<div id="vivliostyle-message-dialog"></div>
<pre id="log"></pre>
<div id="fallback"></div>
<script>
(function(){
  const logEl=document.getElementById('log');
  function log(m){ try{ logEl.style.display='block'; logEl.textContent+=m+'\n'; if(logEl.textContent.length>20000) logEl.textContent=logEl.textContent.slice(-15000);}catch(e){} }
  window.addEventListener('error',e=>log('[onerror] '+e.message));
  window.addEventListener('unhandledrejection',e=>log('[unhandled] '+e.reason));
  // Load viewer from CDN (stable). Could be replaced with self-hosted path later.
  const CDN="https://unpkg.com/@vivliostyle/viewer@latest/lib/js/vivliostyle-viewer.js";
  function loadViewer(){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=CDN;s.onload=()=>res();s.onerror=()=>rej(new Error('viewer load error'));document.head.appendChild(s);});}
  let lastBlob=null; let readyReported=false;
  function makeDoc(d){ const full=d.full||'<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>'+(d.html||'')+'</body></html>'; if(lastBlob) try{URL.revokeObjectURL(lastBlob);}catch{}; const b=new Blob([full],{type:'text/html'}); lastBlob=URL.createObjectURL(b); return {full,url:lastBlob}; }
  function applyContent(d){ const mk=makeDoc(d); location.hash='#src='+encodeURIComponent(mk.url)+'&bookMode=true'; try{ const fb=document.getElementById('fallback'); fb.innerHTML=extractBody(mk.full); fb.style.display='block'; }catch{} log('hash set len='+mk.full.length); }
  function extractBody(h){ const m=h.match(/<body[^>]*>([\s\S]*?)<\/body>/i); return m?m[1]:h; }
  window.addEventListener('message',e=>{ const d=e.data; if(!d||d.type!=='HTML_FULL') return; applyContent(d); });
  function poll(){ let c=0; const iv=setInterval(()=>{ c++; const pc=document.querySelectorAll('[data-vivliostyle-page-container]').length; const st=document.body.getAttribute('data-vivliostyle-viewer-status'); if(pc>0||st){ if(!readyReported){ readyReported=true; try{ const fb=document.getElementById('fallback'); if(pc>0&&fb) fb.style.display='none'; }catch{} parent.postMessage({type:'VIVLIO_RENDER_DONE', pages:pc},'*'); log('ready pages='+pc); } } if(c>240 && !readyReported){ readyReported=true; parent.postMessage({type:'VIVLIO_RENDER_DONE', error:'timeout'},'*'); log('timeout'); clearInterval(iv); } },150); }
  loadViewer().then(()=>{ log('viewer loaded'); poll(); }).catch(err=>{ log('viewer load failed '+err); parent.postMessage({type:'VIVLIO_RENDER_DONE', error:'load-failed'},'*'); });
})();
</script>
</body>
</html>
